terraform {
  required_providers {
    proxmox = {
      source  = "telmate/proxmox"
      version = "3.0.1-rc6" # Versão mais recente estável recomendada quando disponível
    }
  }
}

provider "proxmox" {
  pm_api_url          = "https://brunolab.duckdns.org:8006/api2/json"
  pm_api_token_id     = "terraform@pam!terraform"
  pm_api_token_secret = "c2f576cf-2d2e-4362-80fa-ab029223d6eb"
  pm_tls_insecure     = true
}

resource "proxmox_vm_qemu" "vm-instance" {
  name        = "vm-instance"
  target_node = "brunolab"
  clone       = "ubuntu-2204-template"
  full_clone  = true
  bios        = "seabios"
  scsihw      = "virtio-scsi-single"
  os_type     = "l26"  # Mantido para sistemas Linux modernos
  cores       = 1
  memory      = 1024
  vm_state    = "stopped"
  agent       = 1      # Habilita o QEMU Agent

  boot      = "order=ide2;scsi0;net0;ide0"
  bootdisk  = "scsi0" # Define o disco principal para evitar problemas no Proxmox


  # Cloud-Init configuration
  ciupgrade  = false
  ciuser     = "root"
  cipassword = "test1234"
  ipconfig0  = "ip=dhcp"

  # Serial console
  serial {
    id = 0
  }

  # Main disk (SCSI)
  disk {
    type     = "disk"
    storage  = "local-lvm"
    size     = "32G"
    slot     = "scsi0"
    iothread = true
  }

  # Cloud-init drive (IDE0)
  disk {
    type    = "cloudinit"
    storage = "local-lvm"
    slot    = "ide0"
  }

  # CD/DVD Drive (IDE2) sem mídia
  disk {
    type  = "cdrom"
    slot  = "ide2"
  }

  # Network interface
  network {
    id      = 0
    model   = "virtio"
    bridge  = "vmbr0"
    firewall = true
    # MAC gerado automaticamente pelo Proxmox
  }

  lifecycle {
    ignore_changes = [
      network[0].macaddr,    # Ignora alterações no MAC gerado
      disk,                  # Ignora alterações de tamanho de disco (cuidado!)
      ciuser,                # Ignora alterações no usuário Cloud-Init
      cipassword             # Ignora alterações na senha Cloud-Init
    ]
  }

  timeouts {
    create = "30m"
  }
}